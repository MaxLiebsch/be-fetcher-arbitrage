import { describe, expect, test, beforeAll } from "@jest/globals";
//@ts-ignore
import testParameters from "../utils/testParamter.js";
import {
  extractProductInfos,
  mimicTest,
  myAfterAll,
  myBeforeAll,
  querySellerInfos,
} from "../utils/commonTests.js";
import { CHROME_VERSIONS, generateUpdate } from "@dipmaxtech/clr-pkg";

const shopDomain = "sellercentral.amazon.de";

const product = {
  _id: {
    $oid: "66882c3ef4d9a745d8ec95e0",
  },
  a_pblsh: true,
  a_vrfd: {
    vrfd: false,
    vrfn_pending: true,
    flags: [],
    flag_cnt: 0,
  },
  e_pblsh: true,
  e_vrfd: {
    vrfd: false,
    vrfn_pending: true,
    flags: [],
    flag_cnt: 0,
  },
  lckd: false,
  taskId: "",
  ctgry: ["Sport & Outdoor", "Campingmatten"],
  mnfctr: "Intex",
  nm: "Dura-Beam Classic Downy Airbed",
  img: "https://cdn.idealo.com/folder/Product/201481/7/201481785/s1_produktbild_gross/intex-dura-beam-classic-downy-airbed-cot-64756.jpg",
  lnk: "https://www.idealo.de/preisvergleich/OffersOfProduct/201481785_-dura-beam-classic-downy-airbed-cot-64756-intex-pools.html",
  prc: 7.84,
  a_lnk: "https://www.amazon.de/dp/product/B07LH45G51",
  a_nm: "Intex Luftbett, 64756, bunt, 191 x 76 x 25 cm",
  asin: "B0001D8PBW",
  a_prc: 1,
  a_p_mrgn: -12.36,
  a_p_mrgn_pct: -1236,
  a_p_w_mrgn: -12.47,
  a_p_w_mrgn_pct: -1247,
  a_mrgn: -12.11,
  a_mrgn_pct: -1211,
  a_w_mrgn: -12.22,
  a_w_mrgn_pct: -1222,
  costs: {
    azn: 0.3,
    varc: 0,
    strg_1_hy: 0.19,
    strg_2_hy: 0.3,
    tpt: 5.87,
  },
  tax: 19,
  totalOfferCount: 37,
  buyBoxIsAmazon: false,
  a_img: "https://m.media-amazon.com/images/I/41b218YcfaL._SL120_.jpg",
  bsr: [
    {
      createdAt: "2024-08-12T16:41:07.691Z",
      category: "Küche, Haushalt & Wohnen",
      number: 56,
    },
  ],
  eanList: ["6941057412436"],
  a_orgn: "a",
  a_hash: "",
  createdAt: "2024-07-05T17:24:14.548Z",
  updatedAt: "2024-08-12T16:41:07.746Z",
  e_hash: "6654d216f7dbced77ea424311707b846",
  e_img: "https://i.ebayimg.com/thumbs/images/g/0QEAAOSwaipmYLdJ/s-l500.jpg",
  e_lnk: "https://www.ebay.de/itm/405019483021",
  e_nm: "Intex Dura-Beam Standard Luftbett, 191,76x25cm - Blau (64756)",
  e_orgn: "e",
  e_prc: 10.69,
  esin: "405019483021",
  e_mrgn: 1.11,
  e_mrgn_pct: 10.38,
  e_ns_mrgn: 1.11,
  e_ns_mrgn_pct: 10.38,
  ebyCategories: [
    {
      id: 888,
      createdAt: "2024-08-15T13:55:20.645Z",
      category: "Sport",
    },
  ],
  a_qty: 1,
  a_uprc: 1,
  e_qty: 1,
  e_uprc: 10.69,
  qty: 1,
  s_hash: "3db7b806bf89a35a76e35826742ef688",
  uprc: 7.84,
  a_urpc: 11.99,
  e_urpc: 10.69,
  e_costs: 1.28,
  e_ns_costs: 1.28,
  e_tax: 1.71,
  ahstprcs: [
    6956042, 1199, 7085540, 1489, 7092664, 1652, 7094260, 1800, 7097024, 1911,
    7097412, 1428, 7100396, 1562, 7116502, 1199,
  ],
  anhstprcs: [
    7000244, 910, 7001742, 1119, 7001930, 988, 7002178, 948, 7002318, 921,
    7002546, 910, 7003976, 958, 7004082, 948, 7004256, 921, 7004324, 912,
    7004512, 910, 7005848, 958, 7005916, 948, 7006216, 910, 7007970, 921,
    7008160, 910, 7009596, 958, 7009680, 939, 7009928, 910, 7011316, 1199,
    7011516, 948, 7011632, 930, 7011820, 910, 7013326, 957, 7013512, 929,
    7013732, 910, 7015248, 948, 7015436, 912, 7015652, 910, 7017122, 948,
    7017312, 921, 7017534, 910, 7018888, 959, 7019076, 939, 7019264, 912,
    7019626, 910, 7020960, 939, 7021146, 912, 7021334, 910, 7022730, 959,
    7022954, 930, 7023138, 910, 7024712, 948, 7024876, 921, 7025224, 910,
    7026706, 930, 7027020, 910, 7028684, 921, 7028740, 912, 7028774, 910,
    7030212, 959, 7030276, 958, 7030464, 930, 7030652, 910, 7032330, 921,
    7032516, 910, 7033892, 959, 7033996, 948, 7034200, 921, 7034500, 910,
    7035728, 959, 7035964, 930, 7036188, 910, 7037616, 959, 7037874, 930,
    7038114, 910, 7039556, 948, 7039788, 921, 7040098, 910, 7041436, 948,
    7041624, 921, 7041812, 910, 7043176, 959, 7043320, 930, 7043530, 910,
    7044840, 959, 7045014, 939, 7045206, 912, 7045452, 910, 7046718, 959,
    7055568, 958, 7055944, 959, 7065608, 1006, 7070560, 1119, 7070852, 1006,
    7071476, 1119, 7097036, 999, 7097224, 1119, 7099740, 999, 7100104, 1119,
    7102752, 999, 7103032, 1099, 7105572, 999, 7105920, 1099, 7111300, 999,
    7111668, 1099, 7112608, 999, 7113178, 1099, 7114272, 999, 7114624, 1099,
    7119896, 999, 7120292, 1099, 7121420, 999, 7121788, 1099, 7129886, 999,
    7130058, 1099,
  ],
  auhstprcs: [
    6999456, 969, 7001930, 929, 7004082, 969, 7012006, 936, 7015436, 897,
    7017122, 936, 7023586, 903, 7029236, 990, 7031000, 817, 7031152, 990,
    7033892, 950, 7037874, 990, 7039556, 969, 7041436, 799, 7042056, 969,
    7043176, 929, 7046718, 969, 7050854, 947, 7059444, 1020, 7060852, 554,
    7065794, 1034, 7071852, 1012, 7074586, 970, 7081426, 1012, 7083294, 989,
    7083780, 949, 7084894, 989, 7093142, 1066, 7095320, 999, 7095872, 1066,
    7099404, 1099, 7111300, 969, 7114272, 1099, 7117160, 959, 7117472, 1099,
    7120292, 969,
  ],
  availabilityAmazon: 0,
  avg90_ahsprcs: 1285,
  avg90_ansprcs: 1012,
  avg90_ausprcs: 971,
  avg90_salesRank: 15,
  brand: "Intex",
  categories: [659891031, 675609031, 401392011],
  categoryTree: [
    {
      catId: 3167641,
      name: "Küche, Haushalt & Wohnen",
    },
    {
      catId: 3340952031,
      name: "Bettwaren & Bettwäsche",
    },
    {
      catId: 3341003031,
      name: "Luftbetten & Luftbettzubehör",
    },
    {
      catId: 659891031,
      name: "Luftbetten",
    },
  ],
  curr_ahsprcs: 1199,
  curr_ansprcs: 1099,
  curr_ausprcs: 969,
  curr_salesRank: 6,
  k_eanList: ["6941842806570", "6941057412436"],
  monthlySold: 1977,
  numberOfItems: 1,
  salesRanks: {
    "3167641": [
      7000384, 42, 7000898, 46, 7001196, 44, 7001632, 37, 7002178, 41, 7002546,
      42, 7002812, 36, 7003086, 35, 7003324, 37, 7003536, 41, 7003912, 45,
      7004082, 39, 7004324, 35, 7004700, 37, 7004832, 39, 7005256, 48, 7005444,
      43, 7005848, 42, 7005916, 43, 7006216, 44, 7006864, 43, 7007096, 44,
      7007332, 41, 7008160, 44, 7008372, 43, 7008656, 35, 7008844, 36, 7009406,
      33, 7010300, 27, 7010966, 30, 7011196, 29, 7014688, 26, 7014928, 27,
      7015248, 30, 7015652, 29, 7015868, 26, 7016120, 27, 7016480, 28, 7016756,
      30, 7017122, 31, 7017312, 28, 7018068, 26, 7018444, 22, 7018632, 18,
      7019076, 19, 7019626, 26, 7020018, 22, 7020334, 21, 7020430, 20, 7020676,
      26, 7020960, 31, 7021334, 30, 7021552, 27, 7021852, 28, 7021974, 27,
      7022730, 26, 7023138, 23, 7023398, 25, 7024094, 31, 7024282, 29, 7024472,
      25, 7024712, 22, 7025224, 24, 7025536, 20, 7026204, 19, 7026706, 20,
      7027020, 22, 7027356, 20, 7028320, 21, 7028684, 11, 7028972, 10, 7029236,
      11, 7029646, 13, 7030024, 11, 7030276, 7, 7031000, 9, 7031280, 10,
      7031598, 8, 7032330, 10, 7032598, 12, 7033016, 10, 7033892, 11, 7034838,
      10, 7035224, 12, 7035534, 13, 7035728, 12, 7035964, 10, 7036434, 12,
      7036808, 14, 7037250, 16, 7037440, 17, 7037874, 16, 7038114, 18, 7038208,
      19, 7038984, 18, 7039556, 20, 7039788, 15, 7040286, 14, 7041436, 13,
      7041868, 12, 7042244, 13, 7043176, 12, 7043970, 14, 7044482, 13, 7044840,
      12, 7045014, 13, 7045452, 18, 7045760, 20, 7046160, 22, 7046356, 20,
      7046924, 23, 7047460, 22, 7047942, 21, 7048248, 23, 7048492, 22, 7048932,
      13, 7049476, 14, 7049724, 13, 7050054, 14, 7050296, 12, 7050518, 11,
      7051588, 12, 7051900, 10, 7052952, 14, 7053248, 12, 7054096, 16, 7054280,
      17, 7054706, 13, 7054894, 11, 7055080, 12, 7055340, 14, 7055756, 16,
      7055944, 17, 7056192, 16, 7056380, 15, 7056826, 18, 7057288, 20, 7057674,
      19, 7057956, 17, 7058236, 19, 7058518, 20, 7058868, 16, 7059134, 11,
      7059920, 13, 7060288, 15, 7060528, 11, 7060536, 10, 7060852, 11, 7061468,
      13, 7061798, 8, 7062664, 11, 7063100, 13, 7063288, 9, 7064416, 12,
      7064782, 10, 7065608, 12, 7066848, 14, 7067426, 13, 7069052, 11, 7069844,
      10, 7070364, 9, 7070560, 8, 7072044, 7, 7073124, 8, 7073352, 6, 7073456,
      7, 7074586, 8, 7074852, 7, 7075456, 6, 7077280, 7, 7077650, 8, 7077840, 6,
      7079164, 3, 7082920, 4, 7083420, 3, 7084274, 5, 7085014, 3, 7085724, 2,
      7085880, 3, 7087182, 6, 7087740, 5, 7087990, 3, 7088772, 6, 7089308, 4,
      7089564, 3, 7089854, 5, 7090080, 4, 7090680, 3, 7091480, 5, 7092072, 4,
      7092596, 3, 7092956, 7, 7093668, 8, 7093888, 7, 7094074, 8, 7094482, 11,
      7094698, 12, 7095872, 14, 7096328, 12, 7096860, 10, 7097036, 11, 7097412,
      12, 7097610, 14, 7097992, 13, 7098128, 14, 7098848, 15, 7099404, 12,
      7100104, 11, 7100584, 12, 7100852, 8, 7101072, 9, 7101428, 8, 7101776, 12,
      7102056, 11, 7102198, 8, 7103032, 11, 7103584, 13, 7103832, 12, 7104478,
      14, 7104692, 18, 7105288, 15, 7105920, 16, 7106192, 22, 7106554, 19,
      7106792, 16, 7107128, 14, 7107544, 21, 7107942, 17, 7108132, 16, 7108458,
      17, 7108764, 18, 7109100, 16, 7109288, 11, 7109516, 9, 7110008, 10,
      7110756, 9, 7111300, 6, 7111668, 7, 7113384, 8, 7113568, 7, 7115100, 8,
      7115288, 7, 7116308, 14, 7116502, 12, 7116840, 11, 7117160, 10, 7117472,
      8, 7119262, 7, 7119548, 5, 7119816, 4, 7120292, 6, 7120492, 4, 7120974, 3,
      7121098, 4, 7121420, 7, 7121788, 18, 7121930, 26, 7122260, 35, 7122732,
      33, 7123124, 38, 7123322, 40, 7123824, 41, 7124188, 40, 7124584, 35,
      7124772, 33, 7125132, 29, 7125202, 24, 7126088, 20, 7126382, 18, 7126648,
      14, 7126944, 13, 7127160, 15, 7127420, 14, 7127852, 10, 7128040, 9,
      7128414, 8, 7128546, 9, 7128900, 7, 7129052, 6, 7129612, 5, 7130344, 6,
    ],
    "659891031": [6971606, 1],
  },
  stockAmount: null,
  stockBuyBox: null,
  keepa_lckd: false,
  keepaUpdatedAt: "2024-07-22T16:12:04.523Z",
  aznUpdatedAt: "2024-08-12T16:41:07.746Z",
  ebyUpdatedAt: "2024-08-07T12:54:57.656Z",
  cat_prop: "complete",
  eanUpdatedAt: "2024-08-22T16:28:10.513Z",
  ean_prop: "found",
  eby_prop: "complete",
  infoUpdatedAt: "2024-08-21T08:28:10.513Z",
  info_prop: "complete",
  matched: false,
  matchedAt: "2024-06-25T14:46:13.840Z",
  sku: "6941057412436",
  qEbyUpdatedAt: "2024-08-12T16:41:07.746Z",
  catUpdatedAt: "2024-08-07T12:54:57.656Z",
};

describe(shopDomain.charAt(0).toUpperCase() + shopDomain.slice(1), () => {
  beforeAll(async () => {
    await myBeforeAll(shopDomain);
  }, 1000000);

  test("Mimic for block detection is working", async () => {
    await mimicTest();
  }, 1000000);

  test("Extract product Infos", async () => {
    const addProductInfo = async ({
      productInfo,
      url,
    }: {
      productInfo: any[] | null;
      url: string;
    }) => {
      console.log('productInfo:', productInfo)
      if (productInfo) {
        try {
          const {prc, a_qty, qty} = product
          const update = generateUpdate(productInfo, prc, a_qty, qty);
          console.log(update);
        } catch (error) {
          console.log("error:", error);
          console.log("error in generateUpdate");
        }
      }
    };
    await querySellerInfos(addProductInfo, product.asin || product.eanList[0]);
  }, 200000);

  afterAll(async () => {
    await myAfterAll();
  });
});
